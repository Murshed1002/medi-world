generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model appointments {
  id                 String          @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  patient_id         String?         @db.Uuid
  doctor_id          String?         @db.Uuid
  clinic_id          String?         @db.Uuid
  appointment_date   DateTime        @db.Date
  slot_start_time    DateTime        @db.Time(6)
  slot_end_time      DateTime        @db.Time(6)
  status             String          @db.VarChar(30)
  booking_fee_amount Decimal?        @db.Decimal(10, 2)
  paid_amount        Decimal?        @default(0) @db.Decimal(10, 2)
  queue_token_number Int?
  created_at         DateTime?       @default(now()) @db.Timestamp(6)
  updated_at         DateTime?       @default(now()) @db.Timestamp(6)
  clinics            clinics?        @relation(fields: [clinic_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  doctors            doctors?        @relation(fields: [doctor_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  patients           patients?       @relation(fields: [patient_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  queue_entries      queue_entries[]

  @@index([doctor_id, appointment_date], map: "idx_appt_doctor_date")
  @@index([patient_id], map: "idx_appt_patient")
}

model audit_logs {
  id           String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  entity_type  String?   @db.VarChar(50)
  entity_id    String?   @db.Uuid
  action       String?   @db.VarChar(50)
  performed_by String?   @db.Uuid
  meta         Json?
  created_at   DateTime? @default(now()) @db.Timestamp(6)

  @@index([created_at(sort: Desc)], map: "idx_audit_logs_created")
  @@index([entity_type, entity_id], map: "idx_audit_logs_entity")
  @@index([performed_by], map: "idx_audit_logs_user")
}

model auth_users {
  id             String           @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  phone_number   String           @unique @db.VarChar(15)
  email          String?          @db.VarChar(255)
  role           String           @db.VarChar(30)
  is_active      Boolean?         @default(true)
  created_at     DateTime?        @default(now()) @db.Timestamp(6)
  updated_at     DateTime?        @default(now()) @db.Timestamp(6)
  doctors        doctors?
  patients       patients?
  refresh_tokens refresh_tokens[]

  @@index([phone_number], map: "idx_auth_users_phone")
}

model clinic_queues {
  id                       String          @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  clinic_id                String?         @db.Uuid
  doctor_id                String?         @db.Uuid
  queue_date               DateTime        @db.Date
  current_token_number     Int?            @default(0)
  last_issued_token_number Int?            @default(0)
  status                   String?         @db.VarChar(20)
  created_at               DateTime?       @default(now()) @db.Timestamp(6)
  clinics                  clinics?        @relation(fields: [clinic_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  doctors                  doctors?        @relation(fields: [doctor_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  queue_entries            queue_entries[]

  @@unique([clinic_id, doctor_id, queue_date])
  @@index([queue_date], map: "idx_clinic_queues_date")
}

model clinics {
  id             String           @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name           String           @db.VarChar(255)
  address        String?
  city           String?          @db.VarChar(120)
  latitude       Decimal?         @db.Decimal(9, 6)
  longitude      Decimal?         @db.Decimal(9, 6)
  created_at     DateTime?        @default(now()) @db.Timestamp(6)
  appointments   appointments[]
  clinic_queues  clinic_queues[]
  doctor_clinics doctor_clinics[]
  doctor_slots   doctor_slots[]

  @@index([city], map: "idx_clinics_city")
}

model doctor_clinics {
  doctor_id        String   @db.Uuid
  clinic_id        String   @db.Uuid
  consultation_fee Decimal? @db.Decimal(10, 2)
  booking_fee      Decimal? @db.Decimal(10, 2)
  clinics          clinics  @relation(fields: [clinic_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  doctors          doctors  @relation(fields: [doctor_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@id([doctor_id, clinic_id])
}

model doctor_slots {
  id                    String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  doctor_id             String?  @db.Uuid
  clinic_id             String?  @db.Uuid
  day_of_week           String   @db.VarChar(10)
  start_time            DateTime @db.Time(6)
  end_time              DateTime @db.Time(6)
  slot_duration_minutes Int
  max_patients_per_slot Int?     @default(1)
  clinics               clinics? @relation(fields: [clinic_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  doctors               doctors? @relation(fields: [doctor_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([doctor_id, clinic_id], map: "idx_doctor_slots_doctor_clinic")
}

model doctors {
  id                  String           @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  auth_user_id        String?          @unique @db.Uuid
  full_name           String           @db.VarChar(255)
  specialization      String?          @db.VarChar(120)
  registration_number String?          @db.VarChar(120)
  experience_years    Int?
  is_verified         Boolean?         @default(false)
  created_at          DateTime?        @default(now()) @db.Timestamp(6)
  gender              String?          @db.VarChar(10)
  bio                 String?
  rating              Decimal?         @default(0.0) @db.Decimal(3, 2)
  reviews_count       Int?             @default(0)
  profile_image_url   String?
  supports_video      Boolean?         @default(false)
  appointments        appointments[]
  clinic_queues       clinic_queues[]
  doctor_clinics      doctor_clinics[]
  doctor_reviews      doctor_reviews[]
  doctor_slots        doctor_slots[]
  auth_users          auth_users?      @relation(fields: [auth_user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([specialization], map: "idx_doctors_specialization")
  @@index([rating(sort: Desc)], map: "idx_doctors_rating")
}

model patients {
  id                         String           @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  auth_user_id               String?          @unique @db.Uuid
  full_name                  String           @db.VarChar(255)
  date_of_birth              DateTime?        @db.Date
  gender                     String?          @db.VarChar(10)
  blood_group                String?          @db.VarChar(5)
  address                    String?
  city                       String?          @db.VarChar(120)
  created_at                 DateTime?        @default(now()) @db.Timestamp(6)
  emergency_contact_name     String?          @db.VarChar(255)
  emergency_contact_relation String?          @db.VarChar(50)
  emergency_contact_phone    String?          @db.VarChar(15)
  appointments               appointments[]
  doctor_reviews             doctor_reviews[]
  auth_users                 auth_users?      @relation(fields: [auth_user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  payments                   payments[]

  @@index([auth_user_id], map: "idx_patients_auth_user")
}

model payments {
  id                  String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  patient_id          String    @db.Uuid
  amount              Decimal   @db.Decimal(10, 2)
  currency            String?   @default("INR") @db.VarChar(5)
  payment_type        String    @db.VarChar(40)
  payment_method      String?   @db.VarChar(40)
  provider            String?   @db.VarChar(40)
  provider_order_id   String?   @db.VarChar(255)
  provider_payment_id String?   @db.VarChar(255)
  status              String    @db.VarChar(30)
  metadata            Json?
  created_at          DateTime? @default(now()) @db.Timestamp(6)
  reference_type      String    @db.VarChar(40)
  reference_id        String    @db.Uuid
  updated_at          DateTime? @default(now()) @db.Timestamp(6)
  patients            patients  @relation(fields: [patient_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([provider_order_id], map: "idx_payments_provider")
  @@index([reference_type, reference_id], map: "idx_payments_reference")
  @@index([patient_id, created_at(sort: Desc)], map: "idx_payments_patient")
  @@index([status, created_at(sort: Desc)], map: "idx_payments_status")
}

model queue_entries {
  id              String         @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  clinic_queue_id String?        @db.Uuid
  appointment_id  String?        @db.Uuid
  token_number    Int
  status          String         @db.VarChar(20)
  check_in_time   DateTime?      @db.Timestamp(6)
  call_time       DateTime?      @db.Timestamp(6)
  start_time      DateTime?      @db.Timestamp(6)
  end_time        DateTime?      @db.Timestamp(6)
  appointments    appointments?  @relation(fields: [appointment_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  clinic_queues   clinic_queues? @relation(fields: [clinic_queue_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([clinic_queue_id], map: "idx_queue_entries_queue")
  @@index([appointment_id], map: "idx_queue_entries_appointment")
}

model schema_migrations {
  id         Int       @id @default(autoincrement())
  filename   String?   @unique
  applied_at DateTime? @default(now()) @db.Timestamp(6)
}

model refresh_tokens {
  id                   String           @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  user_id              String           @db.Uuid
  token_hash           String           @db.VarChar(255)
  ip_address           String?          @db.VarChar(45)
  user_agent           String?
  device_info          Json?
  expires_at           DateTime         @db.Timestamp(6)
  revoked              Boolean?         @default(false)
  revoked_at           DateTime?        @db.Timestamp(6)
  replaced_by          String?          @db.Uuid
  created_at           DateTime?        @default(now()) @db.Timestamp(6)
  refresh_tokens       refresh_tokens?  @relation("refresh_tokensTorefresh_tokens", fields: [replaced_by], references: [id], onDelete: NoAction, onUpdate: NoAction)
  other_refresh_tokens refresh_tokens[] @relation("refresh_tokensTorefresh_tokens")
  auth_users           auth_users       @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([user_id], map: "idx_refresh_tokens_user")
  @@index([token_hash], map: "idx_refresh_tokens_hash")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model doctor_reviews {
  id             String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  doctor_id      String?   @db.Uuid
  patient_id     String?   @db.Uuid
  appointment_id String?   @db.Uuid
  rating         Int
  review_text    String?
  helpful_count  Int?      @default(0)
  is_verified    Boolean?  @default(false)
  is_anonymous   Boolean?  @default(false)
  created_at     DateTime? @default(now()) @db.Timestamp(6)
  doctors        doctors?  @relation(fields: [doctor_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  patients       patients? @relation(fields: [patient_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([doctor_id], map: "idx_doctor_reviews_doctor")
  @@index([patient_id], map: "idx_doctor_reviews_patient")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model webhook_events {
  id         String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  provider   String    @db.VarChar(40)
  event_id   String    @db.VarChar(255)
  event_type String?   @db.VarChar(100)
  payload    Json?
  processed  Boolean?  @default(false)
  created_at DateTime? @default(now()) @db.Timestamp(6)

  @@unique([provider, event_id], map: "idx_webhook_events_unique")
}
